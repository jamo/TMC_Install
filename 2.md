#Installing TMC server  to ubuntu 12.10 x32 desktop
## Installing ubuntu on VMware Workstation
### Given you have already installed ubuntu 12.10 on vm.

Hostname: TMC, you can give whatever you want  


## Install some dependencies
`apt-get install git zip unzip imagemagick openjdk-6-jdk openjdk-6-jre openjdk-6-jre-headless ant maven xorg build-essential git curl zlib1g-dev autoconf`  
Install apache2
`apt-get install apache2`

For developing this install screen:
`apt-get install screen`


##Installing RVM
`curl -L https://get.rvm.io | sudo bash -s stable --rails`  
`rvm install 1.9.3-p194`might be required  as well as `rvm 1.9.3-p194 --default`

It created  group `rvm`, every user should be added to it.
##Adding user to a group
`gpasswd -a [user] [group]`

Add user www-data to group rvm
`gpasswd -a www-data rvm`
Adding also me to this group
`gpasswd -a jamo rvm`
Remember to logout after adding yourself to rvm group!

##Creating ssh key and importing it to github
`ssh-keygen -t rsa -b 2096`
add your public key to github

##Configuting TMC server
###Cloning TMC-Server  
https://github.com/testmycode/tmc-server.git  
I decided to place it in my home directory  
`git clone https://github.com/testmycode/tmc-server.git`  
`cd tmc-server`  
> This may require adding ssh key to github  
`git submodule update --init --recursive`  
###Installing gems  

`sudo apt-get install libxslt-dev libxml2-dev` for nokogiri.  
`sudo apt-get install libqt4-dev libqt4-core g++` for capybara-webkit  
for pg  `sudo apt-get install postgresql libpq-dev`
You might need to install rails `gem install rails` 
`gem install bundler && bundle install`
###Configuring config/site.yml
Based on config/site.defaults.yml
Just read that file. No need for (major) changes. You may leave the file as it is.  

###Configuring DB
username: tmc
password: tmc
You need to create user tmc for pg
`sudo -s`
`su postgres`
TAI
`sudo su postgres`
>postgres@TMC:/home/jamo$ createuser tmc -s -P
>Enter password for new role: 
>Enter it again: 
Type in  `tmc`

In /etc/postgresql/9.1/main/pg_hba.conf
Change peer to md5 like this:
>\ # Database administrative login by Unix domain socket
> local   all             postgres                                md5 #peer

>\ # TYPE  DATABASE        USER            ADDRESS                 METHOD

>\ # "local" is for Unix domain socket connections only
> local   all             all                                     md5 #peer
>\ # IPv4 local connections:
> host    all             all             127.0.0.1/32            md5
>\ # IPv6 local connections:
> host    all             all             ::1/128                 md5
>\ # Allow replication connections from localhost, by a user with the
>\ # replication privilege.
>\ #local   replication     postgres                                peer
>\ #host    replication     postgres        127.0.0.1/32            md5
>\ #host    replication     postgres        ::1/128                 md5

`service postgresql restart` 
For chances to have effect
Then 
`rake db:reset` for development db
`env RAILS_ENV=production rake db:reset` for prodution db
############################################################################### 


###Compiling ext/tmc-sandbox
`cd ext/tmc-sandbox`
Now install rest of its dependencys
`sudo apt-get install squashfs-tools multistrap`
`curl -L http://ftp-master.debian.org/archive-key-6.0.asc | sudo apt-key add -`

`sudo make` Note this will take some time :)  
I had to choose processor type, (> 5. Pentium-Pro (M686) (NEW))
And a ton of other questions. I andwered with defaut/recommended answer.  

`sudo apt-get install sqlite3 libsqlite3-dev e2fsprogs e2tools`

Befere running tests change in `tmc-server/ext/tmc-sandbox/web/site.defaults.yml`
TMC user and group toyour username, unless you had user called tmc
>tmc_user: jamo #tmc
>tmc_group: jamo #tmc
Go to `ext/tmc-sandbox/web` and install dependencies with `bundle install`. Compile extensions with `rake ext` and run tests with `rvmsudo rake test`.
If `rvmsudo rake test` gives you following error:
>dnsmasq: failed to create listening socket for 192.168.210.1: Address already in use
Try this: http://www.ubuntugeek.com/how-to-disable-dnsmasq-in-ubuntu-12-04precise.html
And if you dont have network-manager installed check
`ps aux` you might notice some dns related process....

##TODO
should I strart it sandbox :o

In `ext` run `rake compile`.
`sudo apt-get install libicu48`
And install alternative X: `sudo apt-get install xvfb`
Start x:
`Xvfb :9 &`
`export DISPLAY=:9`

And in tmc-server folder run
`rvmsudo rake spec`

If some maven related tests fail, check if `/usr/lib/jvm` has some gcj related files; `sudo apt-get remove gcj-4.6-base`